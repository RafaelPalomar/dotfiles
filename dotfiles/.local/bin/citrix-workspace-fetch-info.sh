#!/usr/bin/env bash
# Simple shell script to fetch Citrix Workspace download information
# This is a fallback if the Guile importer has issues

set -e

CITRIX_PAGE="https://www.citrix.com/downloads/workspace-app/linux/workspace-app-for-linux-latest.html"

echo "Fetching Citrix Workspace download page..." >&2

# Fetch the page
PAGE_CONTENT=$(curl -sL -A "Mozilla/5.0 (X11; Linux x86_64)" "$CITRIX_PAGE")

# Extract download URL from rel attribute (protocol-relative URL)
DEB_URL=$(echo "$PAGE_CONTENT" | grep -oP 'rel="[^"]*icaclient_[0-9.]+_amd64\.deb[^"]*"' | head -1 | cut -d'"' -f2)

# Add https: protocol if URL starts with //
if [ -n "$DEB_URL" ] && [[ "$DEB_URL" == //* ]]; then
    DEB_URL="https:$DEB_URL"
fi

# Keep URL parameters - they contain authentication tokens
# Note: These tokens expire, so the URL is only valid for a limited time

if [ -z "$DEB_URL" ]; then
    echo "Error: Could not find download URL" >&2
    echo "Please visit: $CITRIX_PAGE" >&2
    exit 1
fi

# Extract version from URL
VERSION=$(echo "$DEB_URL" | grep -oP 'icaclient_\K[0-9.]+(?=_amd64\.deb)')

echo "Found Citrix Workspace App version: $VERSION" >&2
echo "Download URL: $DEB_URL" >&2
echo >&2

# Ask if user wants to download and compute hash
if [ "$1" = "--download" ] || [ "$1" = "-d" ]; then
    TEMP_FILE=$(mktemp)
    echo "Downloading package at $TEMP_FILE..." >&2
    trap "rm -f $TEMP_FILE" EXIT

    curl -L -o "$TEMP_FILE" "$DEB_URL"

    echo "Computing hash..." >&2
    HASH=$(guix hash "$TEMP_FILE")

    echo "SHA256 Hash: $HASH" >&2
    echo >&2

    # Output complete package definition with hash
    cat <<'PKGEOF' | sed -e "s/DATEHERE/$(date +%Y-%m-%d)/" -e "s/VERSIONHERE/$VERSION/" -e "s|URLHERE|$DEB_URL|" -e "s/HASHHERE/$HASH/"
;; Generated by citrix-workspace-fetch-info.sh on DATEHERE

(define-module (entelequia packages citrix-workspace)
  #:use-module (guix packages)
  #:use-module (guix download)
  #:use-module (guix build-system gnu)
  #:use-module (guix build syscalls)
  #:use-module (guix gexp)
  #:use-module ((guix licenses) #:prefix license:)
  #:use-module (gnu packages base)
  #:use-module (gnu packages bash)
  #:use-module (gnu packages compression)
  #:use-module (gnu packages libcanberra)
  #:use-module (gnu packages curl)
  #:use-module (gnu packages elf)
  #:use-module (gnu packages pulseaudio)
  #:use-module (gnu packages gtk)
  #:use-module (gnu packages gnome)
  #:use-module (gnu packages libcanberra)
  #:use-module (gnu packages tls)
  #:use-module (gnu packages web)
  #:use-module (gnu packages xorg)
  #:use-module (gnu packages gcc)
  #:use-module (gnu packages linux)
  #:use-module (gnu packages glib)
  #:use-module (gnu packages freedesktop)
  #:use-module (gnu packages audio)
  #:use-module (gnu packages nss)
  #:use-module (gnu packages video)      ; for libva
  #:use-module (gnu packages xdisorg))   ; for libxkbcommon

(define-public citrix-workspace
  (package
    (name "citrix-workspace")
    (version "VERSIONHERE")
    (source
     (origin
       (method url-fetch)
       (uri "URLHERE")
       ;; Specify file-name to avoid invalid characters from URL parameters
       (file-name (string-append name "-" version ".deb"))
       (sha256
        (base32
         "HASHHERE"))))
    (build-system gnu-build-system)
    (arguments
     (list
      #:modules '((guix build gnu-build-system)
                  (guix build utils)
                  (ice-9 match)
                  (ice-9 ftw))  ; For scandir
      #:phases
      #~(modify-phases %standard-phases
          (delete 'configure)
          (delete 'check)
          (delete 'build)
          (replace 'unpack
            (lambda* (#:key source #:allow-other-keys)
              (invoke #$(file-append binutils "/bin/ar") "x" source)
              (invoke #$(file-append tar "/bin/tar") "xf" "data.tar.xz")))
          (replace 'install
            (lambda* (#:key outputs #:allow-other-keys)
              (let* ((out (assoc-ref outputs "out"))
                     (opt (string-append out "/opt"))
                     (bin (string-append out "/bin"))
                     (share (string-append out "/share"))
                     (citrix-dir (string-append opt "/Citrix/ICAClient"))
                     (libs (string-append citrix-dir "/lib"))
                     (rpath (string-join
                             (list
                              libs
                              (string-append out "/lib")
                              (string-append #$gcc:lib "/lib")
                              (string-append #$glibc "/lib")
                              (string-append #$openssl "/lib")
                              (string-append #$pulseaudio "/lib")
                              (string-append #$gtk+ "/lib")
                              (string-append #$cairo "/lib")
                              (string-append #$gdk-pixbuf "/lib")
                              (string-append #$pango "/lib")
                              (string-append #$atk "/lib")
                              (string-append #$glib "/lib")
                              (string-append #$libx11 "/lib")
                              (string-append #$libxext "/lib")
                              (string-append #$libxrender "/lib")
                              (string-append #$libxinerama "/lib")
                              (string-append #$libxrandr "/lib")
                              (string-append #$libxfixes "/lib")
                              (string-append #$nss "/lib")
                              (string-append #$alsa-lib "/lib")
                              (string-append #$util-linux:lib "/lib")
                              (string-append #$libxkbcommon "/lib")
                              (string-append #$libva "/lib"))
                             ":")))

                ;; Create destination directory
                (mkdir-p opt)
                ;; Copy Citrix files from extracted .deb
                (copy-recursively "opt/Citrix" (string-append opt "/Citrix"))

                (mkdir-p bin)
                (with-output-to-file (string-append bin "/wfica")
                  (lambda ()
                    (format #t "#!~a/bin/bash~%"
                            #$(file-append bash-minimal "/"))
                    (format #t "export ICAROOT=~a~%" citrix-dir)
                    (format #t "export LD_LIBRARY_PATH=~a:$LD_LIBRARY_PATH~%" rpath)
                    (format #t "exec ~a/wfica \"$@\"~%" citrix-dir)))
                (chmod (string-append bin "/wfica") #o755)

                (with-output-to-file (string-append bin "/selfservice")
                  (lambda ()
                    (format #t "#!~a/bin/bash~%"
                            #$(file-append bash-minimal "/"))
                    (format #t "export ICAROOT=~a~%" citrix-dir)
                    (format #t "export LD_LIBRARY_PATH=~a:$LD_LIBRARY_PATH~%" rpath)
                    (format #t "exec ~a/util/storebrowse \"$@\"~%" citrix-dir)))
                (chmod (string-append bin "/selfservice") #o755)

                ;; Patch all ELF binaries recursively
                (define (patch-elf-file file)
                  (catch #t
                    (lambda ()
                      (when (and (file-exists? file)
                                 (not (symbolic-link? file))
                                 (access? file X_OK))
                        (let* ((port (open-file file "rb"))
                               (magic (get-bytevector-n port 4)))
                          (close-port port)
                          (when (and (bytevector? magic)
                                     (= (bytevector-length magic) 4)
                                     (= (bytevector-u8-ref magic 0) #x7F)
                                     (= (bytevector-u8-ref magic 1) #x45)
                                     (= (bytevector-u8-ref magic 2) #x4C)
                                     (= (bytevector-u8-ref magic 3) #x46))
                            (format #t "Patching ELF: ~a~%" file)
                            (invoke #$(file-append patchelf "/bin/patchelf")
                                    "--set-rpath" rpath file)
                            (catch #t
                              (lambda ()
                                (invoke #$(file-append patchelf "/bin/patchelf")
                                        "--set-interpreter"
                                        #$(file-append glibc "/lib/ld-linux-x86-64.so.2")
                                        file))
                              (lambda _ #f))))))
                    (lambda _ #f)))

                (define (patch-directory dir)
                  (for-each
                   (lambda (entry)
                     (let ((path (string-append dir "/" entry)))
                       (when (and (file-exists? path)
                                  (not (member entry '("." ".."))))
                         (if (file-is-directory? path)
                             (patch-directory path)
                             (patch-elf-file path)))))
                   (or (scandir dir) '())))

                (format #t "Patching all ELF binaries...~%")
                (patch-directory citrix-dir)

                (when (file-exists? "usr/share")
                  (copy-recursively "usr/share" share))

                (let ((apps-dir (string-append share "/applications")))
                  (mkdir-p apps-dir)
                  (with-output-to-file (string-append apps-dir "/wfica.desktop")
                    (lambda ()
                      (format #t "[Desktop Entry]~%")
                      (format #t "Version=1.0~%")
                      (format #t "Type=Application~%")
                      (format #t "Name=Citrix Workspace~%")
                      (format #t "Comment=Citrix Workspace Client~%")
                      (format #t "Exec=~a/bin/wfica %%f~%" out)
                      (format #t "Icon=~a/share/icons/hicolor/48x48/apps/wfica.png~%" out)
                      (format #t "Terminal=false~%")
                      (format #t "Categories=Network;RemoteAccess;~%")
                      (format #t "MimeType=application/x-ica;~%"))))

                (let ((ica-dir (string-append citrix-dir "/.ICAClient")))
                  (mkdir-p ica-dir)
                  (close-port (open-output-file
                               (string-append ica-dir "/.eula_accepted"))))
                #t))))))
    (native-inputs
     (list tar gzip binutils patchelf))
    (inputs
     (list bash-minimal
           (list gcc "lib")  ; gcc:lib for libstdc++ and libgcc_s
           glibc
           openssl
           openssl-1.1
           pulseaudio
           gtk+
           cairo
           gdk-pixbuf
           pango
           atk
           glib
           libx11
           libxext
           libxrender
           libxinerama
           libxrandr
           libxfixes
           nss
           alsa-lib
           libsecret
           libcanberra
           curl))
    (home-page "https://www.citrix.com/downloads/workspace-app/linux/")
    (synopsis "Citrix Workspace App for remote desktop access")
    (description
     "Citrix Workspace App (formerly Citrix Receiver) is a proprietary client
for accessing remote desktops and applications through Citrix Virtual Apps and
Desktops.  It provides secure access to corporate resources from any device.

This package installs the official Citrix ICA Client for Linux, including
support for HDX protocol, audio redirection, USB redirection, multiple monitors,
and seamless windows.

Note: This is proprietary software distributed under Citrix's terms of service.")
    (license ((@@ (guix licenses) license)
              "Citrix Proprietary"
              "https://www.citrix.com/buy/licensing/agreements.html"
              "Proprietary software license from Citrix"))))
PKGEOF
else
    echo "To download and compute hash, run:" >&2
    echo "  $0 --download" >&2
    echo >&2

    # Output complete package definition without hash
    cat <<'PKGEOF' | sed -e "s/DATEHERE/$(date +%Y-%m-%d)/" -e "s/VERSIONHERE/$VERSION/" -e "s|URLHERE|$DEB_URL|"
;; Generated by citrix-workspace-fetch-info.sh on DATEHERE
;; Run with --download to compute the hash automatically

(define-module (entelequia packages citrix-workspace)
  #:use-module (guix packages)
  #:use-module (guix download)
  #:use-module (guix build-system gnu)
  #:use-module (guix gexp)
  #:use-module ((guix licenses) #:prefix license:)
  #:use-module (gnu packages base)
  #:use-module (gnu packages bash)
  #:use-module (gnu packages compression)
  #:use-module (gnu packages curl)
  #:use-module (gnu packages elf)
  #:use-module (gnu packages pulseaudio)
  #:use-module (gnu packages gtk)
  #:use-module (gnu packages gnome)
  #:use-module (gnu packages libcanberra)
  #:use-module (gnu packages tls)
  #:use-module (gnu packages web)
  #:use-module (gnu packages xorg)
  #:use-module (gnu packages gcc)
  #:use-module (gnu packages linux)
  #:use-module (gnu packages glib)
  #:use-module (gnu packages freedesktop)
  #:use-module (gnu packages audio)
  #:use-module (gnu packages nss)
  #:use-module (gnu packages video)      ; for libva
  #:use-module (gnu packages xdisorg))   ; for libxkbcommon

(define-public citrix-workspace
  (package
    (name "citrix-workspace")
    (version "VERSIONHERE")
    (source
     (origin
       (method url-fetch)
       (uri "URLHERE")
       ;; Specify file-name to avoid invalid characters from URL parameters
       (file-name (string-append name "-" version ".deb"))
       (sha256
        (base32
         "INSERT_HASH_HERE_AFTER_RUNNING_WITH_--download"))))
    (build-system gnu-build-system)
    (arguments
     (list
      #:modules '((guix build gnu-build-system)
                  (guix build utils)
                  (ice-9 match)
                  (ice-9 ftw))  ; For scandir
      #:phases
      #~(modify-phases %standard-phases
          (delete 'configure)
          (delete 'check)
          (delete 'build)
          (replace 'unpack
            (lambda* (#:key source #:allow-other-keys)
              (invoke #$(file-append binutils "/bin/ar") "x" source)
              (invoke #$(file-append tar "/bin/tar") "xf" "data.tar.xz")))
          (replace 'install
            (lambda* (#:key outputs #:allow-other-keys)
              (let* ((out (assoc-ref outputs "out"))
                     (opt (string-append out "/opt"))
                     (bin (string-append out "/bin"))
                     (share (string-append out "/share"))
                     (citrix-dir (string-append opt "/Citrix/ICAClient"))
                     (libs (string-append citrix-dir "/lib"))
                     (rpath (string-join
                             (list
                              libs
                              (string-append out "/lib")
                              (string-append #$gcc:lib "/lib")
                              (string-append #$glibc "/lib")
                              (string-append #$openssl "/lib")
                              (string-append #$pulseaudio "/lib")
                              (string-append #$gtk+ "/lib")
                              (string-append #$cairo "/lib")
                              (string-append #$gdk-pixbuf "/lib")
                              (string-append #$pango "/lib")
                              (string-append #$atk "/lib")
                              (string-append #$glib "/lib")
                              (string-append #$libx11 "/lib")
                              (string-append #$libxext "/lib")
                              (string-append #$libxrender "/lib")
                              (string-append #$libxinerama "/lib")
                              (string-append #$libxrandr "/lib")
                              (string-append #$libxfixes "/lib")
                              (string-append #$nss "/lib")
                              (string-append #$alsa-lib "/lib")
                              (string-append #$util-linux:lib "/lib")
                              (string-append #$libxkbcommon "/lib")
                              (string-append #$libva "/lib"))
                             ":")))

                ;; Create destination directory
                (mkdir-p opt)
                ;; Copy Citrix files from extracted .deb
                (copy-recursively "opt/Citrix" (string-append opt "/Citrix"))

                (mkdir-p bin)
                (with-output-to-file (string-append bin "/wfica")
                  (lambda ()
                    (format #t "#!~a/bin/bash~%"
                            #$(file-append bash-minimal "/"))
                    (format #t "export ICAROOT=~a~%" citrix-dir)
                    (format #t "export LD_LIBRARY_PATH=~a:$LD_LIBRARY_PATH~%" rpath)
                    (format #t "exec ~a/wfica \"$@\"~%" citrix-dir)))
                (chmod (string-append bin "/wfica") #o755)

                (with-output-to-file (string-append bin "/selfservice")
                  (lambda ()
                    (format #t "#!~a/bin/bash~%"
                            #$(file-append bash-minimal "/"))
                    (format #t "export ICAROOT=~a~%" citrix-dir)
                    (format #t "export LD_LIBRARY_PATH=~a:$LD_LIBRARY_PATH~%" rpath)
                    (format #t "exec ~a/util/storebrowse \"$@\"~%" citrix-dir)))
                (chmod (string-append bin "/selfservice") #o755)

                ;; Patch all ELF binaries recursively
                (define (patch-elf-file file)
                  (catch #t
                    (lambda ()
                      (when (and (file-exists? file)
                                 (not (symbolic-link? file))
                                 (access? file X_OK))
                        (let* ((port (open-file file "rb"))
                               (magic (get-bytevector-n port 4)))
                          (close-port port)
                          (when (and (bytevector? magic)
                                     (= (bytevector-length magic) 4)
                                     (= (bytevector-u8-ref magic 0) #x7F)
                                     (= (bytevector-u8-ref magic 1) #x45)
                                     (= (bytevector-u8-ref magic 2) #x4C)
                                     (= (bytevector-u8-ref magic 3) #x46))
                            (format #t "Patching ELF: ~a~%" file)
                            (invoke #$(file-append patchelf "/bin/patchelf")
                                    "--set-rpath" rpath file)
                            (catch #t
                              (lambda ()
                                (invoke #$(file-append patchelf "/bin/patchelf")
                                        "--set-interpreter"
                                        #$(file-append glibc "/lib/ld-linux-x86-64.so.2")
                                        file))
                              (lambda _ #f))))))
                    (lambda _ #f)))

                (define (patch-directory dir)
                  (for-each
                   (lambda (entry)
                     (let ((path (string-append dir "/" entry)))
                       (when (and (file-exists? path)
                                  (not (member entry '("." ".."))))
                         (if (file-is-directory? path)
                             (patch-directory path)
                             (patch-elf-file path)))))
                   (or (scandir dir) '())))

                (format #t "Patching all ELF binaries...~%")
                (patch-directory citrix-dir)

                (when (file-exists? "usr/share")
                  (copy-recursively "usr/share" share))

                (let ((apps-dir (string-append share "/applications")))
                  (mkdir-p apps-dir)
                  (with-output-to-file (string-append apps-dir "/wfica.desktop")
                    (lambda ()
                      (format #t "[Desktop Entry]~%")
                      (format #t "Version=1.0~%")
                      (format #t "Type=Application~%")
                      (format #t "Name=Citrix Workspace~%")
                      (format #t "Comment=Citrix Workspace Client~%")
                      (format #t "Exec=~a/bin/wfica %%f~%" out)
                      (format #t "Icon=~a/share/icons/hicolor/48x48/apps/wfica.png~%" out)
                      (format #t "Terminal=false~%")
                      (format #t "Categories=Network;RemoteAccess;~%")
                      (format #t "MimeType=application/x-ica;~%"))))

                (let ((ica-dir (string-append citrix-dir "/.ICAClient")))
                  (mkdir-p ica-dir)
                  (close-port (open-output-file
                               (string-append ica-dir "/.eula_accepted"))))
                #t))))))
    (native-inputs
     (list tar gzip binutils patchelf))
    (inputs
     (list bash-minimal
           (list gcc "lib")  ; gcc:lib for libstdc++ and libgcc_s
           glibc
           openssl
           openssl-1.1
           pulseaudio
           gtk+
           cairo
           gdk-pixbuf
           pango
           atk
           glib
           libx11
           libxext
           libxrender
           libxinerama
           libxrandr
           libxfixes
           nss
           alsa-lib
           libsecret
           libcanberra
           curl))
    (home-page "https://www.citrix.com/downloads/workspace-app/linux/")
    (synopsis "Citrix Workspace App for remote desktop access")
    (description
     "Citrix Workspace App (formerly Citrix Receiver) is a proprietary client
for accessing remote desktops and applications through Citrix Virtual Apps and
Desktops.  It provides secure access to corporate resources from any device.

This package installs the official Citrix ICA Client for Linux, including
support for HDX protocol, audio redirection, USB redirection, multiple monitors,
and seamless windows.

Note: This is proprietary software distributed under Citrix's terms of service.")
    (license ((@@ (guix licenses) license)
              "Citrix Proprietary"
              "https://www.citrix.com/buy/licensing/agreements.html"
              "Proprietary software license from Citrix"))))
PKGEOF

    echo >&2
    echo ";; To get the hash, run:" >&2
    echo ";;   $0 --download" >&2
    echo ";; Or manually:" >&2
    echo ";;   guix download $DEB_URL" >&2
fi
